{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <h2 class="title mb-4">Sejf Saldo</h2>
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-wallet2 fs-1 text-primary mb-2"></i>
          <h5 class="card-title">Saldo gotówki</h5>
          <p class="saldo fs-3 fw-bold">{{ current_safe_balance }} PLN</p>
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <form class="row g-2 align-items-end" id="safeFilterForm" onsubmit="return false;">
        <div class="col-auto">
          <label class="form-label">Od:</label>
          <input type="date" id="filterStart" class="form-control" value="{{ start_date }}">
        </div>
        <div class="col-auto">
          <label class="form-label">Do:</label>
          <input type="date" id="filterEnd" class="form-control" value="{{ end_date }}">
        </div>
        <div class="col-auto">
          <button id="filterBtn" class="btn btn-primary">Filtruj</button>
        </div>
      </form>
      <form method="post" class="row g-2 align-items-end mt-3" id="safeAddForm">
        <div class="col-auto">
          <label class="form-label">Kwota:</label>
          <input type="number" step="0.01" name="amount" class="form-control"/>
        </div>
        <div class="col-auto">
          <label class="form-label">Typ:</label>
          <select name="type" class="form-select">
            <option value="wpłata">Wpłata</option>
            <option value="wypłata">Wypłata</option>
          </select>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-success">Dodaj operację</button>
        </div>
      </form>
    </div>
  </div>
  <div class="card mb-4 shadow-sm">
    <div class="card-header">Saldo w czasie</div>
    <div class="card-body p-0">
      <div class="ratio ratio-16x9" style="max-height:300px;">
        <canvas id="balanceChart"></canvas>
      </div>
    </div>
  </div>
  <h4>Historia operacji</h4>
  <table class="table table-striped">
    <thead><tr><th>Data</th><th>Typ</th><th>Kwota</th><th>Saldo</th><th>Użytkownik</th></tr></thead>
    <tbody id="txTable">
      {% for t in transactions %}
      <tr>
        <td>{{ t.date }}</td>
        <td>{{ t.type }}</td>
        <td>{{ t.amount }}</td>
        <td>{{ t.balance }}</td>
        <td>{{ t.user.username }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // inline JS to handle chart and filtering
  async function fetchSummary(start,end) {
    const resp = await fetch(`/api/sejf_saldo/summary?start=${start}&end=${end}`);
    return resp.json();
  }
  let balanceChart;
  function fmt(d) { return d.toISOString().slice(0,10); }
  document.addEventListener('DOMContentLoaded', () => {
    const startInput = document.getElementById('filterStart');
    const endInput = document.getElementById('filterEnd');
    const today = new Date();
    const last = new Date(today.getTime() - 7*24*60*60*1000);
    if(!startInput.value) startInput.value = fmt(last);
    if(!endInput.value) endInput.value = fmt(today);
    const ctx = document.getElementById('balanceChart').getContext('2d');
    balanceChart = new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'Saldo',data:[],fill:true,tension:0.3}]},options:{responsive:true,maintainAspectRatio:false}});
    async function refresh() {
      const data = await fetchSummary(startInput.value,endInput.value);
      balanceChart.data.labels = data.history.map(x=>x.date);
      balanceChart.data.datasets[0].data = data.history.map(x=>x.balance);
      balanceChart.update();
      // update table
      const tbody = document.getElementById('txTable'), rows = data.transactions;
      tbody.innerHTML='';
      rows.forEach(r=>{tbody.innerHTML+=`<tr><td>${r.date}</td><td>${r.type}</td><td>${r.amount}</td><td>${r.balanceAfter}</td><td>${r.user}</td></tr>`});
    }
    document.getElementById('filterBtn').addEventListener('click',refresh);
    refresh();
  });
</script>
{% endblock %}