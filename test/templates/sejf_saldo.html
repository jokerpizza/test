{% import 'datetime' as datetime %}
{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <h2 class="text-center mb-4">Sejf Saldo</h2>
  <div class="row mb-4">
    <div class="col-md-4 mb-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-wallet2 fs-1 text-primary mb-2"></i>
          <h5>Saldo gotówki</h5>
          <p id="currentBalance" class="fs-3 fw-bold">{{ current_safe_balance }} zł</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-arrow-down-circle fs-1 text-success mb-2"></i>
          <h6 class="text-muted">Wpłaty ({{ (datetime.strptime(end_date_str, '%Y-%m-%d') - datetime.strptime(start_date_str, '%Y-%m-%d')).days }}d)</h6>
          <p id="totalDeposits" class="fs-4">{{ totalDeposits }} zł</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-arrow-up-circle fs-1 text-danger mb-2"></i>
          <h6 class="text-muted">Wypłaty ({{ (datetime.strptime(end_date_str, '%Y-%m-%d') - datetime.strptime(start_date_str, '%Y-%m-%d')).days }}d)</h6>
          <p id="totalWithdrawals" class="fs-4">{{ totalWithdrawals }} zł</p>
        </div>
      </div>
    </div>
  </div>
  <div class="card mb-4 shadow-sm">
    <div class="card-header">Saldo w czasie</div>
    <div class="card-body p-0">
      <div class="ratio ratio-16x9" style="max-height:300px;">
        <canvas id="balanceChart"></canvas>
      </div>
    </div>
  </div>
  <div class="row mb-4">
    <div class="col-md-6">
      <form method="get" id="safeFilterForm" class="card shadow-sm p-3">
        <h6>Filtruj transakcje</h6>
        <div class="row g-2 align-items-end">
          <div class="col-auto">
            <label>Od dnia:</label>
            <input type="date" name="start_date_str" class="form-control" value="{{ start_date_str }}"/>
          </div>
          <div class="col-auto">
            <label>Do dnia:</label>
            <input type="date" name="end_date_str" class="form-control" value="{{ end_date_str }}"/>
          </div>
          <div class="col-auto">
            <button class="btn btn-primary">Pokaż</button>
          </div>
        </div>
      </form>
    </div>
    <div class="col-md-6">
      <form method="post" id="safeAddForm" class="card shadow-sm p-3">
        <h6>Dodaj operację</h6>
        <div class="row g-2 align-items-end">
          <div class="col-auto flex-grow-1">
            <label>Kwota:</label>
            <input type="number" step="0.01" name="amount" class="form-control" placeholder="Wpisz kwotę"/>
          </div>
          <div class="col-auto flex-grow-1">
            <label>Typ operacji:</label>
            <select name="type" class="form-select">
              <option value="wpłata">Wpłata</option>
              <option value="wypłata">Wypłata</option>
            </select>
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-success">Dodaj operację</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <h5>Historia operacji</h5>
  <div class="table-responsive mb-4">
    <table class="table table-striped">
      <thead class="table-primary">
        <tr>
          <th>Data</th><th>Opis/Typ</th><th>Kwota</th><th>Saldo po trans.</th><th>Użytkownik</th>
        </tr>
      </thead>
      <tbody>
        {% for t in transactions %}
        <tr>
          <td>{{ t.date }}</td><td>{{ t.type }}</td><td>{{ t.amount }}</td><td>{{ t.balance_after }}</td><td>{{ t.user }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="card mb-4 shadow-sm">
    <div class="card-header">Alerty Progowe Sejfu</div>
    <div class="card-body">
      <table class="table mb-3">
        <thead><tr><th>Typ</th><th>Próg (zł)</th><th>Usuń</th></tr></thead>
        <tbody>
          {% for thr in thresholds %}
          <tr><td>{{ thr.key }}</td><td>{{ thr.value }}</td><td>
            <form method="post" action="{{ url_for('delete_threshold', id=thr.id) }}">
              <button class="btn btn-sm btn-danger">Usuń</button>
            </form>
          </td></tr>
          {% endfor %}
        </tbody>
      </table>
      <form method="post" action="{{ url_for('add_threshold') }}">
        <div class="row g-2 align-items-end">
          <div class="col-auto">
            <input name="type" class="form-control" placeholder="Typ alertu"/>
          </div>
          <div class="col-auto">
            <input name="value" type="number" step="0.01" class="form-control" placeholder="Próg (zł)"/>
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-primary">Dodaj Alert Progowy</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const history = {{ history|tojson }};
  const ctx = document.getElementById('balanceChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data:{labels: history.map(h=>h.date), datasets:[{label:'Saldo', data:history.map(h=>h.balance), fill:true, tension:0.3}]},
    options:{responsive:true, maintainAspectRatio:false}
  });
</script>
{% endblock %}
