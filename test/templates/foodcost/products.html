{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Produkty</h2>
  <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#productModal">Dodaj produkt</button>
  <table class="table table-striped">
    <thead><tr><th>Nazwa</th><th>Cena/kg</th><th>Akcje</th></tr></thead>
    <tbody id="prodTable">
      {% for p in products %}
      <tr data-id="{{p.id}}">
        <td>{{p.name}}</td>
        <td><span class="price">{{'%.2f'|format(p.price_per_kg)}}</span></td>
        <td><button class="btn btn-sm btn-outline-secondary edit-price">Edytuj</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<!-- Modal -->
<div class="modal fade" id="productModal"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5>Dodaj produkt</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <input id="newProdName" class="form-control mb-2" placeholder="Nazwa">
    <input id="newProdPrice" type="number" step="0.01" class="form-control" placeholder="Cena/kg">
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
    <button id="saveProd" class="btn btn-primary">Zapisz</button>
  </div>
</div></div></div>

{% endblock %}
{% block scripts %}
<script>
document.getElementById('saveProd').onclick = () => {
  fetch('/foodcost/api/products', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      name: document.getElementById('newProdName').value,
      price_per_kg: parseFloat(document.getElementById('newProdPrice').value)
    })
  }).then(()=>location.reload());
};
document.querySelectorAll('.edit-price').forEach(btn=>{
  btn.onclick=()=> {
    const tr = btn.closest('tr'), id=tr.dataset.id, span=tr.querySelector('.price');
    const old=span.textContent;
    span.innerHTML=`<input type="number" step="0.01" value="${old}" class="form-control form-control-sm">`;
    btn.textContent='Zapisz';
    btn.onclick=()=> {
      const v=tr.querySelector('input').value;
      fetch(`/foodcost/api/products/${id}`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({price_per_kg: parseFloat(v)})
      }).then(()=>location.reload());
    };
  };
});
</script>
{% endblock %}