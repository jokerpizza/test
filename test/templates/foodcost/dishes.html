{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Dania</h2>
  <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#dishModal">Dodaj danie</button>
  <table class="table table-striped">
    <thead><tr><th>Nazwa</th><th>Cena</th></tr></thead>
    <tbody>
      {% for d in dishes %}
      <tr><td>{{d.name}}</td><td>{{'%.2f'|format(d.sale_price)}}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<!-- Modal -->
<div class="modal fade" id="dishModal"><div class="modal-dialog modal-lg"><div class="modal-content">
  <div class="modal-header"><h5>Dodaj danie</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <input id="dishName" class="form-control mb-2" placeholder="Nazwa dania">
    <input id="dishPrice" type="number" step="0.01" class="form-control mb-3" placeholder="Cena sprzedaży">
    <div id="recipeItems"></div>
    <button id="addIng" class="btn btn-link">+ Dodaj składnik</button>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
    <button id="saveDish" class="btn btn-primary">Zapisz</button>
  </div>
</div></div></div>

{% endblock %}
{% block scripts %}
<script>
const products = {{ products|tojson }};
let idx=0;
document.getElementById('addIng').onclick=()=>{
  const sel=document.createElement('select'); sel.className='form-select mb-2';
  sel.id='prod_'+idx;
  products.forEach(p=> sel.innerHTML+=`<option value="${p.id}">${p.name}</option>`);
  const inp=document.createElement('input'); inp.type='number'; inp.step='0.01';
  inp.className='form-control mb-2'; inp.id='wt_'+idx; inp.placeholder='kg';
  document.getElementById('recipeItems').append(sel, inp);
  idx++;
};
document.getElementById('saveDish').onclick=()=>{
  const recipe=[];
  for(let i=0;i<idx;i++){
    const pid=document.getElementById('prod_'+i).value;
    const wt=parseFloat(document.getElementById('wt_'+i).value);
    if(pid && wt) recipe.push({product_id:+pid, weight_kg:wt});
  }
  fetch('/foodcost/api/dishes',{method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      name: document.getElementById('dishName').value,
      sale_price: parseFloat(document.getElementById('dishPrice').value),
      recipe: recipe
    })
  }).then(()=>location.reload());
};
</script>
{% endblock %}